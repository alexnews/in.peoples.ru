# Moderation Panel Design

## Access

URL: `www/moderate/`
Requires: `moderator` or `admin` role (enforced by `requireRole('moderator')`)

---

## Dashboard (/moderate/index.php)

```
┌──────────────────────────────────────────────────────────┐
│  Модерация peoples.ru          Добро пожаловать, Админ!  │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌──────────┐│
│  │ Ожидают   │ │ Сегодня   │ │ Сегодня   │ │ Активных ││
│  │ проверки  │ │ одобрено  │ │ отклонено │ │ авторов  ││
│  │    15     │ │     8     │ │     2     │ │   120    ││
│  └───────────┘ └───────────┘ └───────────┘ └──────────┘│
│                                                          │
│  ── По типам в очереди ──                                │
│  Биографии: 5  │ Новости: 4  │ Фото: 3  │ Факты: 3    │
│                                                          │
│  ── Последние действия ──                                │
│  │ 14:30 │ Вы одобрили биографию "Тарковский" от ivan   │
│  │ 14:15 │ admin отклонил фото от user123               │
│  │ 13:50 │ Вы запросили доработку новости от marina_k    │
│                                                          │
│  ── Лучшие авторы (месяц) ──                             │
│  1. Иван Петров — 22 публикации                          │
│  2. Марина К. — 18 публикаций                            │
│  3. Сергей Н. — 12 публикаций                            │
└──────────────────────────────────────────────────────────┘
```

---

## Review Queue (/moderate/queue.php)

```
┌──────────────────────────────────────────────────────────┐
│  Очередь модерации                                       │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Фильтр: [Все типы ▾] [Pending ▾] [Сначала старые ▾]   │
│                                                          │
│  ☐ Выбрать все  │ [Одобрить выбранные] [Отклонить выбр.]│
│                                                          │
│  ┌─────┬────────────────────┬───────────┬──────┬───────┐ │
│  │  ☐  │ Материал           │ Автор     │ Тип  │ Дата  │ │
│  ├─────┼────────────────────┼───────────┼──────┼───────┤ │
│  │  ☐  │ Биография:         │ ivan_p    │ 📝   │ 10.06 │ │
│  │     │ Тарковский         │ ⭐150     │      │       │ │
│  ├─────┼────────────────────┼───────────┼──────┼───────┤ │
│  │  ☐  │ Фото: Высоцкий    │ marina_k  │ 📷   │ 09.06 │ │
│  │     │ (3 фото)           │ ⭐85      │      │       │ │
│  ├─────┼────────────────────┼───────────┼──────┼───────┤ │
│  │  ☐  │ Новость: Премьера  │ user123   │ 📰   │ 08.06 │ │
│  │     │ фильма             │ ⭐12      │      │       │ │
│  └─────┴────────────────────┴───────────┴──────┴───────┘ │
│                                                          │
│  Клавиши: J/K — навигация, Enter — открыть, A — одобрить │
└──────────────────────────────────────────────────────────┘
```

---

## Single Review (/moderate/review.php?id={id})

### Biography Review

```
┌──────────────────────────────────────────────────────────┐
│  Проверка: Биография Андрея Тарковского                  │
│  Автор: ivan_petrov (⭐150, 22 публикации)               │
├──────────────┬───────────────────────────────────────────┤
│ Текущая      │ Предложенная                              │
│ биография    │ версия                                    │
│ (если есть)  │                                           │
├──────────────┤                                           │
│              │ Андрей Арсеньевич Тарковский               │
│ [нет данных] │ родился 4 апреля 1932 года                │
│              │ в селе Завражье Костромской               │
│              │ области. Советский                         │
│              │ кинорежиссёр, сценарист...                │
│              │                                           │
│              │ [Полный текст...]                          │
├──────────────┴───────────────────────────────────────────┤
│                                                          │
│  Персона: Андрей Тарковский (ID: 5432)                   │
│  Эпиграф: Великий советский кинорежиссёр                 │
│  Источник: https://example.com/source                    │
│  Версия: 1 │ Создано: 10.06.2025 14:22                  │
│                                                          │
│  Комментарий модератора:                                 │
│  [________________________________________________]      │
│                                                          │
│  [✅ Одобрить]  [⚠️ На доработку]  [❌ Отклонить]        │
│                                                          │
│  Горячие клавиши: A — одобрить, E — доработка, R — откл. │
└──────────────────────────────────────────────────────────┘
```

### Photo Review

```
┌──────────────────────────────────────────────────────────┐
│  Проверка: Фотографии Владимира Высоцкого                │
│  Автор: marina_k (⭐85)                                  │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │              │  │              │  │              │   │
│  │   [photo1]   │  │   [photo2]   │  │   [photo3]   │   │
│  │              │  │              │  │              │   │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤   │
│  │ "На концерте │  │ "В гримёрке" │  │ "На съёмках" │   │
│  │  1975 года"  │  │              │  │  х/ф 'Место  │   │
│  │              │  │              │  │  встречи'"   │   │
│  │ ☐ Одобрить   │  │ ☐ Одобрить   │  │ ☐ Одобрить   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                          │
│  [✅ Одобрить выбранные]  [❌ Отклонить все]             │
└──────────────────────────────────────────────────────────┘
```

Individual photos can be approved/rejected independently.

---

## User Management (/moderate/users.php)

```
┌──────────────────────────────────────────────────────────┐
│  Управление пользователями                               │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Поиск: [_______________] [Все роли ▾] [Все статусы ▾]  │
│                                                          │
│  ┌──────────┬───────────┬──────┬───────┬────────┬──────┐│
│  │ Имя      │ Email     │ Роль │ Репут.│ Публ.  │ Дейст││
│  ├──────────┼───────────┼──────┼───────┼────────┼──────┤│
│  │ ivan_p   │ iv@...    │ user │ 150   │ 22     │ [⚙️] ││
│  │ marina_k │ ma@...    │ user │ 85    │ 14     │ [⚙️] ││
│  │ spammer1 │ sp@...    │ user │ -5    │ 0      │ [⚙️] ││
│  └──────────┴───────────┴──────┴───────┴────────┴──────┘│
│                                                          │
│  ⚙️ Действия: Просмотр │ Модератор ↑ │ Бан │ Разбан     │
└──────────────────────────────────────────────────────────┘
```

---

## User Detail (/moderate/user-detail.php?id={id})

```
┌──────────────────────────────────────────────────────────┐
│  Пользователь: ivan_petrov                               │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Статус: Активен │ Роль: Пользователь │ Репутация: 150   │
│  Дата регистрации: 15.01.2025 │ Последний вход: 10.06   │
│                                                          │
│  Статистика:                                             │
│  Всего материалов: 28 │ Одобрено: 22 │ Отклонено: 4     │
│  Фото: 45 │ Биографии: 12 │ Новости: 8 │ Факты: 6      │
│                                                          │
│  Достижения: 🏅 📸 ✍️ 📰                                 │
│                                                          │
│  ── Последние материалы ──                               │
│  [list of recent submissions with status]                │
│                                                          │
│  ── История модерации ──                                 │
│  [timeline of all moderation actions on this user]       │
│                                                          │
│  Действия: [Назначить модератором] [Забанить] [Удалить]  │
└──────────────────────────────────────────────────────────┘
```

---

## Moderation Log (/moderate/log.php)

Audit trail of all moderation actions:

```
┌──────────────────────────────────────────────────────────┐
│  Журнал модерации                                        │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Фильтр: [Все модераторы ▾] [Все действия ▾] [Дата ▾]  │
│                                                          │
│  │ 10.06 14:30 │ admin    │ Одобрил  │ Биография #101  │ │
│  │ 10.06 14:15 │ admin    │ Отклонил │ Фото #55        │ │
│  │ 10.06 13:50 │ mod_user │ Доработка│ Новость #88     │ │
│  │ 09.06 18:20 │ admin    │ Бан      │ User: spammer1  │ │
└──────────────────────────────────────────────────────────┘
```

---

## Approval Workflow: What Happens on "Approve"

When a moderator clicks "Approve", the API performs these steps:

### For Biography:
1. `UPDATE user_submissions SET status='approved', moderator_id=?, reviewed_at=NOW()`
2. Convert content cp1251 if needed
3. `INSERT INTO histories (KodPersons, Content, Epigraph, NameURLArticle, ...)`
4. `UPDATE user_submissions SET published_id=LAST_INSERT_ID(), published_table='histories'`
5. `INSERT INTO user_reputation_log (user_id, action='submission_approved', points=15)`
6. `UPDATE users SET reputation = reputation + 15 WHERE id = ?`
7. Check badge conditions, award if met

### For Photo:
1. Move from `uploads/temp/{user_id}/` to `www/photo/{person_path}/`
2. `INSERT INTO photo (KodPersons, NamePhoto, path_photo, ...)`
3. Update published_id/table
4. Award 5 reputation points
5. Update person's photo count (or let UpdatePersonsCounts handle it)

### For News:
1. `INSERT INTO news (KodPersons, ...content..., approve='YES')`
2. Update published_id/table
3. Award 10 reputation points

---

## Keyboard Shortcuts

| Key     | Action                              |
|---------|-------------------------------------|
| J       | Next item in queue                  |
| K       | Previous item in queue              |
| Enter   | Open selected item                  |
| A       | Approve current item                |
| E       | Request revision (edit)             |
| R       | Reject current item                 |
| Escape  | Back to queue                       |
| /       | Focus search box                    |
| ?       | Show keyboard shortcuts help        |
